<?xml version='1.0' encoding='UTF-8'?>
<sdf version="1.6">
  <model name="rov_max">
    <pose>0 0 0 0 0 0</pose>

    <link name="rov_max_frame">
    </link>

    <!-- ***************************** -->
    <!-- ********* CHASSIS *********** -->
    <!-- ***************************** -->
    <link name="rov_max_shell">
      <pose>1.5571 0.0016 0.0084 0 3.1416 0</pose>  
      <visual name="rov_max_shell_visual">
        <geometry>
          <mesh>
            <uri>model://rov_max/meshes/rov_max.stl</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
        <material>
            <ambient>1 1 0 0.7</ambient>
            <diffuse>1 1 0 0.7</diffuse>
            <specular>1 1 0 0.7</specular>
        </material>
      </visual>
      
      <!-- Collision volume * fluid_density == displaced mass, used by BuoyancyPlugin -->
      <collision name="rov_max_shell_collision">
        <pose>1.5571 -0.0016 -0.0084 0 0 0</pose>
        <geometry>
          <box>
            <size>3.65 2.5 1</size>
          </box>
        </geometry>
      </collision>

      <inertial>
        <pose>1.5571 -0.0016 -0.0084 0 0 0</pose>  
        <mass>13.2</mass>
        <inertia>
          <ixx>0.15</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.66</iyy>
          <iyz>0</iyz>
          <izz>0.53</izz>
        </inertia>
      </inertial>

      <!-- IMU sensor gyro and accel data will be sent to ArduSub -->
      <sensor name="imu_sensor" type="imu">
        <!-- Transform from the Gazebo body frame (x-forward, y-left, z-up)
             to the ArduPilot body frame (x-forward, y-right, z-down) -->
        <pose>0 0 0 3.141592653589793 0 0</pose>
        <always_on>1</always_on>
        <update_rate>1000.0</update_rate>
      </sensor>

    </link>

    <joint name="base_frame_to_shell" type="fixed">
      <parent>rov_max_frame</parent>
      <child>rov_max_shell</child>
    </joint>

    <!-- ***************************** -->
    <!-- *********** CAMERA ********** -->
    <!-- ***************************** -->
    <link name="camera">
      <pose>1.5571 0 0 0 0 0</pose>
      <visual name="camera_tube">
        <geometry>
          <box>
            <size>0.2 0.4 0.2</size>
          </box>
        </geometry>
        <material>
            <ambient>0.7 0.7 0.7 1.0</ambient>
            <diffuse>0.7 0.7 0.7 1.0</diffuse>
            <specular>0.7 0.7 0.7 1.0</specular>
        </material>
      </visual>
      <sensor name="sensor_camera" type="camera">
        <pose>0 0 -0.08750000000000001 0 0 0</pose>
        <camera>
          <horizontal_fov>1.4</horizontal_fov>
          <image>
            <width>800</width>
            <height>600</height>
          </image>
          <clip>
            <near>0.4</near>
            <far>100</far>
          </clip>
        </camera>
        <always_on>1</always_on>
        <update_rate>5</update_rate>
        <visualize>true</visualize>
        <topic>/model/rov_max/camera</topic>
      </sensor>
      <inertial>
        <mass>0.001</mass>
        <inertia>
          <ixx>0.001</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.001</iyy>
          <iyz>0</iyz>
          <izz>0.001</izz>
        </inertia>
      </inertial>
    </link>

    <!-- Attach camera_link to rov_max_shell -->
    <joint name="shell_to_camera" type="fixed">
      <parent>rov_max_shell</parent>
      <child>camera</child>
    </joint>

    <!-- ***************************** -->
    <!-- **** VERTICAL THRUST LEFT *** -->
    <!-- ***************************** -->
    <link name="vert_thrust_left">
      <pose>1.08 0.71 0 0 0 0</pose>
      <visual name="thruster_prop_visual">
        <pose>0 0 0 1.5707963267948966 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://rov_max/meshes/t200-cw-prop.dae</uri>
            <scale>6 6 6</scale>
          </mesh>
        </geometry>
      </visual>
      <inertial>
        <mass>0.001</mass>
        <inertia>
          <ixx>0.001</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.001</iyy>
          <iyz>0</iyz>
          <izz>0.001</izz>
        </inertia>
      </inertial>
    </link>

    <joint name="shell_to_vert_thrust_left" type="revolute">
      <parent>rov_max_shell</parent>
      <child>vert_thrust_left</child>
      <axis>
        <xyz>0 0 -1</xyz>
      </axis>
    </joint>

    <!-- ***************************** -->
    <!-- *** VERTICAL THRUST RIGHT *** -->
    <!-- ***************************** -->
    <link name="vert_thrust_right">
      <pose>1.08 -0.71 0 0 0 0</pose>
      <visual name="thruster_prop_visual">
        <pose>0 0 0 -1.5707963267948966 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://rov_max/meshes/t200-ccw-prop.dae</uri>
            <scale>6 6 6</scale>
          </mesh>
        </geometry>
      </visual>
      <inertial>
        <mass>0.001</mass>
        <inertia>
          <ixx>0.001</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.001</iyy>
          <iyz>0</iyz>
          <izz>0.001</izz>
        </inertia>
      </inertial>
    </link>

    <joint name="shell_to_vert_thrust_right" type="revolute">
      <parent>rov_max_shell</parent>
      <child>vert_thrust_right</child>
      <axis>
        <xyz>0 0 -1</xyz>
      </axis>
    </joint>

    <!-- ***************************** -->
    <!-- ******* THRUSTER LEFT ******* -->
    <!-- ***************************** -->
    <link name="left_thruster">
      <pose>-1.2429 0.75 0 0 1.5707963267948966 0</pose>
      <visual name="thruster_prop_visual">
        <pose>0 0 0 -1.5707963267948966 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://rov_max/meshes/t200-ccw-prop.dae</uri>
            <scale>6 6 6</scale>
          </mesh>
        </geometry>
      </visual>
      <inertial>
        <mass>0.001</mass>
        <inertia>
          <ixx>0.001</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.001</iyy>
          <iyz>0</iyz>
          <izz>0.001</izz>
        </inertia>
      </inertial>
    </link>

    <joint name="shell_to_left_thrust" type="revolute">
      <parent>rov_max_shell</parent>
      <child>left_thruster</child>
      <axis>
        <xyz>0 0 -1</xyz>
      </axis>
    </joint>

    <!-- ***************************** -->
    <!-- ******* THRUSTER RIGHT ****** -->
    <!-- ***************************** -->
    <link name="right_thruster">
      <pose>-1.2429 -0.75 0 0 1.5707963267948966 0</pose>
      <visual name="thruster_prop_visual">
        <pose>0 0 0 1.5707963267948966 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://rov_max/meshes/t200-cw-prop.dae</uri>
            <scale>6 6 6</scale>
          </mesh>
        </geometry>
      </visual>
      <inertial>
        <mass>0.001</mass>
        <inertia>
          <ixx>0.001</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>0.001</iyy>
          <iyz>0</iyz>
          <izz>0.001</izz>
        </inertia>
      </inertial>
    </link>

    <joint name="shell_to_right_thrust" type="revolute">
      <parent>rov_max_shell</parent>
      <child>right_thruster</child>
      <axis>
        <xyz>0 0 -1</xyz>
      </axis>
    </joint>

    <!-- ***************************** -->
    <!-- ********** PLUGINS ********** -->
    <!-- ***************************** -->
    
    <!-- CHASSIS - HYDRODYNAMICS PLUGINS -->
    <plugin
        filename="gz-sim-hydrodynamics-system"
        name="gz::sim::systems::Hydrodynamics">
      <link_name>rov_max_shell</link_name>
      <water_density>1000</water_density>
      <!-- Added mass: -->
      <xDotU>0</xDotU>
      <yDotV>0</yDotV>
      <zDotW>0</zDotW>
      <kDotP>0</kDotP>
      <mDotQ>0</mDotQ>
      <nDotR>0</nDotR>
      <!-- First order stability derivative: -->
      <xU>0</xU>
      <yV>0</yV>
      <zW>0</zW>
      <kP>0</kP>
      <mQ>0</mQ>
      <nR>0</nR>
      <!-- Second order stability derivative: -->
      <xUabsU>-33.800000000000004</xUabsU>
      <yVabsV>-54.26875</yVabsV>
      <zWabsW>-73.37135</zWabsW>
      <kPabsP>-4.0</kPabsP>
      <mQabsQ>-4.0</mQabsQ>
      <nRabsR>-4.0</nRabsR>
    </plugin>

    <!-- **** PLUGINS FOR THRUSTERS **** -->
    <!-- VERTICAL THRUST LEFT -->
    <plugin
        filename="gz-sim-thruster-system"
        name="gz::sim::systems::Thruster">
      <namespace>rov_max</namespace>
      <joint_name>shell_to_vert_thrust_left</joint_name>
      <thrust_coefficient>0.02</thrust_coefficient>
      <fluid_density>1000</fluid_density>
      <propeller_diameter>0.55</propeller_diameter>
      <velocity_control>true</velocity_control>
      <use_angvel_cmd>False</use_angvel_cmd>
    </plugin>

    <!-- VERTICAL THRUST RIGHT -->
    <plugin
        filename="gz-sim-thruster-system"
        name="gz::sim::systems::Thruster">
      <namespace>rov_max</namespace>
      <joint_name>shell_to_vert_thrust_right</joint_name>
      <thrust_coefficient>-0.02</thrust_coefficient>
      <fluid_density>1000</fluid_density>
      <propeller_diameter>0.55</propeller_diameter>
      <velocity_control>true</velocity_control>
      <use_angvel_cmd>False</use_angvel_cmd>
    </plugin>

    <!-- THRUSTER RIGHT -->
    <plugin
        filename="gz-sim-thruster-system"
        name="gz::sim::systems::Thruster">
      <namespace>rov_max</namespace>
      <joint_name>shell_to_left_thrust</joint_name>
      <thrust_coefficient>0.02</thrust_coefficient>
      <fluid_density>1000</fluid_density>
      <propeller_diameter>0.55</propeller_diameter>
      <velocity_control>true</velocity_control>
      <use_angvel_cmd>False</use_angvel_cmd>
    </plugin>

    <!-- THRUSTER RIGHT -->
    <plugin
        filename="gz-sim-thruster-system"
        name="gz::sim::systems::Thruster">
      <namespace>rov_max</namespace>
      <joint_name>shell_to_right_thrust</joint_name>
      <thrust_coefficient>-0.02</thrust_coefficient>
      <fluid_density>1000</fluid_density>
      <propeller_diameter>0.55</propeller_diameter>
      <velocity_control>true</velocity_control>
      <use_angvel_cmd>False</use_angvel_cmd>
    </plugin>

    <!-- ARDUPILOT - COMUNNICATION -->
    <plugin name="ArduPilotPlugin" filename="libArduPilotPlugin.so">
      <!-- Port settings -->
      <fdm_addr>127.0.0.1</fdm_addr>
      <fdm_port_in>9002</fdm_port_in>
      <connectionTimeoutMaxCount>5</connectionTimeoutMaxCount>
      <lock_step>1</lock_step>

      <!-- Transform from the Gazebo body frame (x-forward, y-left, z-up)
           to the ArduPilot body frame (x-forward, y-right, z-down) -->
      <modelXYZToAirplaneXForwardZDown>0 0 0 3.141592653589793 0 0</modelXYZToAirplaneXForwardZDown>

      <!-- Transform from the Gazebo world frame (ENU)
           to the ArduPilot world frame (NED) -->
      <gazeboXYZToNED>0 0 0 3.141592653589793 0 1.5707963267948966</gazeboXYZToNED>

      <!-- Sensors -->
      <imuName>imu_sensor</imuName>

      <!-- Thrusters -->
      <control channel="0">
        <jointName>shell_to_vert_thrust_left</jointName>
        <servo_min>1100</servo_min>
        <servo_max>1900</servo_max>
        <type>COMMAND</type>
        <cmd_topic>/model/rov_max/joint/shell_to_vert_thrust_left/cmd_thrust</cmd_topic>
        <offset>-0.5</offset>
        <multiplier>100</multiplier>
      </control>
      <control channel="1">
        <jointName>shell_to_vert_thrust_right</jointName>
        <servo_min>1100</servo_min>
        <servo_max>1900</servo_max>
        <type>COMMAND</type>
        <cmd_topic>/model/rov_max/joint/shell_to_vert_thrust_right/cmd_thrust</cmd_topic>
        <offset>-0.5</offset>
        <multiplier>100</multiplier>
      </control>
      <control channel="2">
        <jointName>shell_to_left_thrust</jointName>
        <servo_min>1100</servo_min>
        <servo_max>1900</servo_max>
        <type>COMMAND</type>
        <cmd_topic>/model/rov_max/joint/shell_to_left_thrust/cmd_thrust</cmd_topic>
        <offset>-0.5</offset>
        <multiplier>100</multiplier>
      </control>
      <control channel="3">
        <jointName>shell_to_right_thrust</jointName>
        <servo_min>1100</servo_min>
        <servo_max>1900</servo_max>
        <type>COMMAND</type>
        <cmd_topic>/model/rov_max/joint/shell_to_right_thrust/cmd_thrust</cmd_topic>
        <offset>-0.5</offset>
        <multiplier>100</multiplier>
      </control>

    </plugin>

    <!-- PUBLISH THE GROUND-TRUTH POSE FOR RVIZ2 -->
    <plugin
        filename="gz-sim-odometry-publisher-system"
        name="gz::sim::systems::OdometryPublisher">
      <odom_frame>map</odom_frame>
      <robot_base_frame>rov_max_sim</robot_base_frame>
      <dimensions>3</dimensions>
    </plugin>

  </model>
</sdf>
